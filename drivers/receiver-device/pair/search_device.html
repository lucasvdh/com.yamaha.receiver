<link href="../../../assets/pairing.css" rel="stylesheet">

<div class="container">
    <p data-i18n="pair.search_device.intro"></p>

    <table class="pairSettings">
        <tr>
            <th data-i18n="pair.search_device.ipAddress">IP address</th>
        </tr>
        <tr>
            <td><input id="ipAddress" type="text" value="192.168.1.10" placeholder=""/></td>
        </tr>
        <tr>
            <td class="info" data-i18n="pair.search_device.ipAddressDescription"></td>
        </tr>
        <tr>
            <th data-i18n="pair.search_device.zone">Zone</th>
        </tr>
        <tr>
            <td data-i18n="pair.search_device.select_zone">
                Choose to select a default zone or provide your own.
            </td>
        </tr>
        <tr>
            <td style="padding-bottom: 1rem;">
                <div class="radio-group">
                    <input id="default" type="radio" name="zone_type" value="default" checked>
                    <label for="default" data-i18n="pair.zone.default">
                        Default
                    </label>
                    <input id="custom" type="radio" name="zone_type" value="custom">
                    <label for="custom" data-i18n="pair.zone.custom">
                        Custom
                    </label>
                </div>
            </td>
        </tr>
        <tr class="zone-default">
            <td>
                <select id="zone-default" name="zone">
                    <option value="Main_Zone" selected>Main zone</option>
                    <option value="Zone_2">Zone 2</option>
                    <option value="Zone_3">Zone 3</option>
                    <option value="Zone_4">Zone 4</option>
                </select>
            </td>
        </tr>
        <tr class="zone-custom hidden">
            <td>
                <input id="custom-zone" type="text" value="Main_Zone" placeholder=""/>
                <p class="info" data-i18n="pair.search_device.custom_zone_info">
                    You can provide a custom zone if you have changed this via the Yamaha app.
                </p>
            </td>
        </tr>
    </table>
</div>

<a class="btn btn-success btn-block btn-lg" id="saveButton" data-i18n="pair.search_device.submit"
   onclick="submit()">Save</a>

<script>
    var saveButton = document.getElementById('saveButton');
    var ipAddressElement = document.getElementById('ipAddress');
    var zoneElement = document.getElementById('zone');
    var loading = true;

    Homey.setTitle(__('pair.search_device.title'));

    Homey.on('error', function (errortype, callback) {
        if (errortype === 'error') {
            Homey.alert(__('error.generic'), 'error');
            Homey.done();
        } else if (errortype === 'invalid_zone') {
            Homey.alert(__('error.invalidZone'), 'error');
        } else if (errortype === 'not_found') {
            Homey.alert(__('error.endpointNotFound'), 'error');
        } else if (errortype === 'host_unreachable') {
            Homey.alert(__('error.hostUnreachable'), 'error');
        } else if (errortype === 'host_timeout') {
            Homey.alert(__('error.connectionTimedOut'), 'error');
        } else {
            Homey.alert(JSON.stringify(errortype));
        }
    });

    Homey.on('continue', function (success, callback) {
        loading = false;
        Homey.showView('list_devices');
    })

    var defaultZone = (document.getElementsByClassName("zone-default"))[0];
    var customZone = document.getElementsByClassName("zone-custom")[0];
    var zoneTypeRadios = document.getElementsByName('zone_type');

    for (var i = 0; i < zoneTypeRadios.length; i++) {
        zoneTypeRadios[i].addEventListener('change', (event) => {
            if (event.target.value === 'custom' && event.target.checked) {
                customZone.classList.remove('hidden');
                defaultZone.classList.add('hidden');
            } else if (event.target.value === 'default' && event.target.checked) {
                customZone.classList.add('hidden');
                defaultZone.classList.remove('hidden');
            }
        });
    }

    function submit() {
        if (loading) {
            console.log('Loading ..')
        }
        saveButton.classList.add('loading-fade-out');
        loading = true;

        console.log('Saving settings...');

        let ipAddress = ipAddressElement.value,
            zoneTypeElement = document.querySelector('input[name="zone_type"]:checked'),
            zone;

        if (zoneTypeElement.value === 'default') {
            zone = document.querySelector('select#zone-default').value
        } else {
            zone = document.querySelector('input#custom-zone').value
        }

        console.log('zone', zone);

        // If required values are filled in
        if (ipAddress !== '') {
            // Build data array
            let data = {
                ipAddress: ipAddress,
                zone: zone,
                validate: true
            };

            console.log('Saving device data', data);

            // Continue to back-end, pass along data
            Homey.emit('validate_data', data);
        } else {
            saveButton.classList.remove('loading-fade-out');
            loading = false;
        }
    }

</script>